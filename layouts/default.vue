<template>
  <header class="pt-3 pb-3">
    <div class="container">
      <div class="row">
        <div class="col-md-2">
          <NuxtLink to="/" class="logo">
            <div class="logo">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                version="1.1"
                id="Layer_1"
                width="180"
                height="35"
                x="0px"
                y="0px"
                viewBox="61.84 43 876.65 180"
                enable-background="new 0 0 1000 265"
                xml:space="preserve"
              >
                <path
                  fill="#333333"
                  d="M328.742,49.396c-1.806,2.955-3.69,6.027-5.657,9.227c-1.968,3.198-4.102,6.606-6.397,10.212  c-2.953,4.76-5.947,9.596-8.98,14.514c-3.038,4.924-6.114,9.928-9.225,15.009c-3.286,5.088-6.44,10.131-9.474,15.134  c-3.039,5.006-6.027,9.881-8.979,14.637c-2.299,3.612-4.472,7.056-6.52,10.335c-2.052,3.286-3.979,6.483-5.782,9.594  c-1.15,1.808-2.053,4.104-2.707,6.892c-0.657,2.79-0.984,5.253-0.984,7.381v52.897c0,2.134-0.739,3.935-2.215,5.415  c-1.477,1.472-3.283,2.211-5.413,2.211h-19.435c-2.134,0-3.898-0.739-5.291-2.211c-1.396-1.48-2.093-3.281-2.093-5.415V162.33  c0-2.128-0.367-4.591-1.107-7.381c-0.735-2.788-1.683-5.084-2.828-6.892c-4.76-8.363-9.638-16.604-14.64-24.726  c-5.006-8.117-10.129-16.274-15.378-24.482c-5.413-8.363-10.663-16.604-15.745-24.726c-5.086-8.118-10.007-16.358-14.763-24.728  c-1.149-1.799-1.353-3.321-0.615-4.549c0.738-1.23,2.171-1.847,4.305-1.847h25.097c2.128,0,4.304,0.617,6.519,1.847  c2.215,1.229,3.814,2.75,4.796,4.549c3.116,5.252,6.234,10.501,9.351,15.751c3.114,5.25,6.312,10.578,9.596,15.989  c3.113,5.413,6.231,10.748,9.349,15.994c3.113,5.25,6.233,10.5,9.35,15.747c0.984,1.805,2.252,2.707,3.812,2.707  c1.558,0,2.91-0.902,4.061-2.707c1.145-1.967,2.336-3.935,3.566-5.905c1.231-1.969,2.499-4.018,3.814-6.15l11.81-19.931  c1.968-3.279,3.893-6.559,5.78-9.842c1.885-3.274,3.815-6.556,5.784-9.84c1.311-1.969,2.54-3.937,3.689-5.906  c1.145-1.968,2.296-3.935,3.446-5.907c0.982-1.799,2.582-3.321,4.797-4.549c2.214-1.23,4.387-1.847,6.52-1.847h25.096  c2.131,0,3.526,0.617,4.182,1.847C329.888,46.075,329.726,47.597,328.742,49.396z"
                />
                <path
                  fill="#333333"
                  d="M937.211,215.37c-4.122-7.511-30.618-57.645-36.251-68.306c-0.676-1.279-0.835-1.439-0.694-1.908  s0.832-0.558,1.409-0.806c20.835-8.953,27.724-26.659,27.724-48.906c0-29.577-25.018-52.445-55.656-52.445h-69.279  c-2.055,0-3.85,0.627-5.272,2.049c-1.422,1.422-2.19,3.079-2.19,5.13v164.898c0,2.054,0.769,4.078,2.184,5.502  C800.6,222,802.389,223,804.436,223h18.645c2.043,0,3.656-1,4.996-2.421c1.334-1.424,1.924-3.448,1.924-5.502v-58.763v-1.649  c0-2.052,0.818-3.45,2.238-4.874c1.422-1.422,3.262-1.791,5.317-1.791h18.245c2.052,0,4.274,0.033,6.488,1.137  c2.21,1.107,4.413,2.166,5.937,4.275l2.142,2.98c0,0,28.79,57.517,31.477,61.15c1.264,1.581,3,2.809,5.214,3.913  c2.21,1.105,4.342,1.544,6.397,1.544h20.912c2.053,0,3.355-0.773,3.911-2.512C938.829,218.75,938.246,217.255,937.211,215.37z   M837.892,120c-2.056,0-3.563-0.407-4.985-1.829c-1.422-1.422-1.906-2.854-1.906-4.909V80.029c0-2.051,0.484-4.134,1.906-5.554  c1.422-1.422,2.93-2.475,4.985-2.475h33.041c13.535,0,25.275,9.998,25.275,23.168c0,13.92-11.74,24.832-25.275,24.832H837.892z"
                />
                <path
                  fill="#333333"
                  d="M463.03,45.186c-1.46-1.457-3.238-2.186-5.344-2.186h-97.575c-2.119,0-4.177,0.767-5.643,2.229  c-1.465,1.47-2.468,3.292-2.468,5.411v165.118c0,2.112,1.003,3.742,2.468,5.207c1.466,1.467,3.524,2.035,5.643,2.035h19.057  c2.114,0,4.038-0.568,5.503-2.035c1.467-1.465,2.329-3.095,2.329-5.207V150l49.121-0.001c2.106,0,3.884-0.689,5.343-2.065  c1.454-1.373,2.182-3.114,2.182-5.223v-19.177c0-2.101-0.729-3.884-2.182-5.341c-1.459-1.457-3.237-2.185-5.343-2.185L387,116  V85.024c0-2.124,0.603-4.134,2.068-5.6c1.466-1.467,3.126-2.424,5.246-2.424l63.373-0.004c2.106,0,3.884-0.688,5.344-2.064  c1.453-1.375,2.183-3.116,2.182-5.222V50.527C465.212,48.426,464.483,46.643,463.03,45.186z"
                />
                <path
                  fill="#333333"
                  d="M621.818,45.064C620.357,43.688,618.58,43,616.474,43H495.526c-2.106,0-3.884,0.688-5.344,2.064  C488.729,46.439,488,48.18,488,50.287v19.182c0,2.102,0.729,3.885,2.182,5.342c1.46,1.456,3.238,2.186,5.344,2.186L531.572,77  c2.119,0,3.898,0.905,5.363,2.371c1.122,1.122,2.064,2.605,2.064,4.11v132.173c0,2.112,0.746,3.794,2.212,5.258  c1.466,1.469,3.267,2.088,5.386,2.088h0.121h18.562h0.121c2.119,0,3.92-0.619,5.386-2.088c1.466-1.464,2.212-3.146,2.212-5.258  V83.481c0-1.505,0.942-2.988,2.064-4.11c1.465-1.466,3.244-2.371,5.363-2.371l36.046-0.004c2.106,0,3.884-0.729,5.345-2.186  c1.453-1.457,2.182-3.24,2.182-5.342V50.287C624,48.18,623.271,46.439,621.818,45.064z"
                />
                <path
                  fill="#333333"
                  d="M170.754,191.184c-1.474-1.469-3.268-2.206-5.393-2.206l-61.838,0.006c-2.114,0-3.901-0.732-5.364-2.194  c-1.462-1.463-2.194-3.246-2.194-5.364V50.553c0-2.107-0.729-3.898-2.193-5.358C92.31,43.73,90.52,43,88.411,43H69.397  c-2.114,0-3.899,0.73-5.362,2.195c-1.462,1.46-2.195,3.251-2.195,5.358v164.748c0,2.112,0.733,3.896,2.195,5.364  c1.462,1.458,3.248,2.19,5.362,2.19h95.964c2.125,0,3.919-0.693,5.393-2.083c1.466-1.388,2.203-3.146,2.202-5.27v-18.929  C172.956,194.454,172.221,192.653,170.754,191.184z"
                />
                <path
                  fill="#333333"
                  d="M770.818,45.188c-1.461-1.456-3.238-2.186-5.344-2.186l-96.949,0c-2.105,0-3.883,0.688-5.344,2.064  c-1.453,1.375-2.183,3.115-2.182,5.221v19.184c0,2.102,0.729,3.885,2.182,5.342c1.461,1.455,3.238,2.186,5.344,2.186l96.949,0  c2.105,0,3.883-0.688,5.344-2.064c1.453-1.375,2.183-3.115,2.182-5.221V50.53C773,48.428,772.271,46.645,770.818,45.188z"
                />
                <path
                  fill="#333333"
                  d="M770.841,118.187c-1.461-1.455-3.238-2.186-5.344-2.186l-114.949,0c-2.105,0-3.883,0.688-5.344,2.064  c-1.453,1.375-2.183,3.115-2.182,5.221v19.184c0,2.102,0.729,3.885,2.182,5.342c1.461,1.455,3.238,2.186,5.344,2.186h114.949  c2.105,0,3.883-0.688,5.344-2.064c1.453-1.375,2.183-3.115,2.182-5.221v-19.184C773.022,121.427,772.294,119.644,770.841,118.187z"
                />
                <path
                  fill="#333333"
                  d="M770.818,191.188c-1.461-1.455-3.238-2.186-5.344-2.186H633.525c-2.105,0-3.883,0.688-5.344,2.064  c-1.453,1.375-2.183,3.115-2.182,5.221v19.184c0,2.102,0.729,3.885,2.182,5.342c1.461,1.455,3.238,2.186,5.344,2.186h131.949  c2.105,0,3.883-0.688,5.344-2.064c1.453-1.375,2.183-3.115,2.182-5.221v-19.184C773,194.428,772.271,192.645,770.818,191.188z"
                />
              </svg>
            </div>
          </NuxtLink>
        </div>

        <div class="col-md-6">
          <div class="search-container m-auto">
            <input
              type="text"
              class="form-control search-input"
              placeholder="Zoek blokken...   ( sprijd trefworden met: , )"
              v-model="searchBar"
              v-debounce:600ms.cancelonempty="search"
            />
            <span class="search-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                <path
                  d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z"
                />
              </svg>
            </span>
          </div>
        </div>

        <div class="col-md-4">
          <nav
            class="navbar navbar-expand-lg navbar-light p-0 flex-row-reverse"
          >
            <ul class="navbar-nav">
              <li class="nav-item">
                <NuxtLink to="/" class="nav-link">Blokken</NuxtLink>
              </li>
              <li class="nav-item">
                <NuxtLink to="/pending" class="nav-link">Pending</NuxtLink>
              </li>
              <li>
                <NuxtLink to="/categories" class="nav-link">
                  categorie-boom
                </NuxtLink>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </header>

  <section class="page">
    <div class="row" v-auto-animate>
      <div class="col-md-2" v-if="needsFilter">
        <div class="sidebar">
          <div class="container-fluid">
            <h5 class="pt-3 pb-3">Fitlers</h5>

            <h6>Categories</h6>

            <div class="categorie-filters">
              <div class="inner" :class="moreCats ? 'show' : ''">
                <div
                  class="form-check"
                  v-for="category in categories"
                  :key="category.id"
                >
                  <input
                    class="form-check-input"
                    type="checkbox"
                    :value="category.id"
                    v-model="selectedCats"
                    v-on:change="setFilterState"
                  />
                  <label class="form-check-label">
                    {{ category.category }}
                  </label>
                </div>
              </div>

              <div v-if="categories.length > 10" class="cats-view-more">
                <button
                  type="button"
                  class="btn btn-link"
                  @click="moreCats = !moreCats"
                >
                  {{ moreCats ? "minder" : "meer" }} categorieÃ«n
                </button>
              </div>
            </div>

            <h6 class="pt-5">Tags</h6>

            <div class="tag-filters">
              <div class="inner">
                <div class="form-check" v-for="tag in tags" :key="tag.id">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    :value="tag.id"
                    v-model="selectedTags"
                    v-on:change="setFilterState"
                  />
                  <label class="form-check-label">
                    {{ tag.tag }}
                  </label>
                </div>
              </div>

              <div v-if="tags.length > 10" class="cats-view-more">
                <button
                  type="button"
                  class="btn btn-link"
                  @click="moreTags = !moreTags"
                >
                  {{ moreTags ? "minder" : "meer" }} tags
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div :class="needsFilter ? 'col-md-10' : 'col-md-12'">
        <slot></slot>
      </div>

      <AppSearchModal
        :search-results="searchResults"
        :visible="visibleResults"
        @closeModal="toggleModal"
      />
    </div>
  </section>
</template>

<script setup lang="ts">
import vueDebounce from "vue-debounce";
import { getCategoriesTags } from "~/composables/getCategoriesTag";
import type { Block, Category, Tag } from "~/lib/generated/prisma";

const { tags: preTags, categories: preCategories } = await getCategoriesTags();

const route = useRoute();
const needsFilter = ref(true);
const filterPaths = ["/"];
const moreCats = ref(false);
const moreTags = ref(false);

const vDebounce = vueDebounce({
  lock: true,
});
const tags = ref<Tag[]>(preTags);
const categories = ref<Category[]>(preCategories);

const searchBar = ref<string>("");
const selectedTags = ref<string[]>([]);
const selectedCats = ref<string[]>([]);
const filterState = useState<{ tagIds: string[]; categorieIds: string[] }>(
  "filterState"
);
const searchResults = ref<Block[]>([]);
const visibleResults = ref(false);

watch(route, () => {
  checkRoute();
});

onBeforeMount(() => {
  checkRoute();
});

const checkRoute = () => {
  needsFilter.value = filterPaths.some((path) => {
    return route.path === path;
  });
};

const setFilterState = () => {
  filterState.value = {
    tagIds: selectedTags.value,
    categorieIds: selectedCats.value,
  };
};

const search = async () => {
  const { data, status } = await useAsyncData("searchBlocks", () =>
    $fetch("/api/search-blocks", {
      method: "POST",
      body: { keywords: searchBar.value.split(",").map((word) => word.trim()) },
    })
  );

  if (status.value === "success") {
    searchResults.value = data.value as Block[];
    visibleResults.value = true;
  }
};

const toggleModal = () => {
  visibleResults.value = false;
};
</script>

<style scoped>
.search-container {
  position: relative;
  width: 70%;
}

.search-container .search-icon {
  position: absolute;
  top: 10%;
  right: 15px;
  width: 20px;
  height: 20px;
}

header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #fff;
  z-index: 10;
  box-shadow: 0px -20px 20px 2px #000;
}

.page {
  margin-top: 75px;
}

.sidebar {
  position: fixed;
  top: 75px;
  left: 0;
  width: inherit;
  background-color: aliceblue;
  min-height: 90vh;
  max-height: 90vh;
  min-height: 90dvh;
  max-height: 90dvh;
  overflow-y: auto;
  padding-bottom: 20px;
}

.categorie-filters .inner {
  overflow: hidden;
  max-height: 16.5rem;
}

.categorie-filters .inner.show {
  max-height: 100rem;
  overflow-y: auto;
}
</style>
